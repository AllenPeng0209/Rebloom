# 每日心理總結功能設置指南

## 功能概述

本系統實現了一個完整的每日心理總結功能，具備專業心理師水平的分析能力，能夠：

- 🧠 **智能分析**: 使用百鍊AI分析用戶的每日對話內容
- ⏰ **自動執行**: 每晚10點自動生成心理總結
- 💾 **數據存儲**: 將分析結果存儲到Supabase數據庫
- 📱 **前端展示**: 在心情頁面展示歷史洞察和趨勢
- 🔔 **智能提醒**: 檢測風險並提供個人化建議

## 已實現功能

### ✅ 1. 數據庫結構
- 創建了 `daily_summaries` 表，包含完整的心理分析字段
- 支持情緒分析、行為模式、風險評估等專業維度
- 啟用了RLS（行級安全）確保數據隱私

### ✅ 2. AI分析服務 (`SummaryService`)
- **對話數據收集**: 自動獲取用戶當日的所有對話記錄
- **專業心理分析**: 使用百鍊AI進行深度心理學分析
- **結構化輸出**: 生成包含洞察、建議、風險評估的完整報告
- **數據持久化**: 將分析結果保存到數據庫

### ✅ 3. 定時任務系統 (`SchedulerService`)
- **自動調度**: 每晚10點自動執行總結生成
- **用戶管理**: 為每個用戶獨立設置調度任務
- **狀態追蹤**: 防止重複執行，記錄執行歷史
- **手動觸發**: 支持用戶主動生成總結

### ✅ 4. 前端展示組件
- **`DailyInsightCard`**: 詳細展示單日心理洞察
- **`SummaryHistoryView`**: 歷史總結列表和趨勢展示
- **心情頁面整合**: 無縫整合到現有UI中

### ✅ 5. 系統整合
- **應用啟動**: 在應用啟動時自動初始化調度服務
- **用戶註冊**: 新用戶完成onboarding後自動設置定時任務
- **數據類型**: 完整的TypeScript類型定義

## 核心特性

### 🧠 專業心理分析
系統提供心理師級別的分析，包括：

- **心理洞察**: 深度分析用戶的情緒狀態和心理需求
- **治療觀察**: 從專業角度評估溝通模式和防禦機制
- **行為模式**: 識別適應性和非適應性行為模式
- **個人化建議**: 基於分析結果提供具體可行的建議

### 📊 全面數據追蹤
- **情緒分析**: 主要情緒識別和強度評估
- **心情趨勢**: improving/stable/declining/mixed分類
- **風險評估**: 自動檢測潛在的心理健康風險
- **進展追蹤**: 記錄目標、成就和挑戰

### 🔐 隱私保護
- **行級安全**: 每個用戶只能訪問自己的數據
- **本地調度**: 使用AsyncStorage存儲調度信息
- **安全API**: 所有數據傳輸都經過加密

## 使用方法

### 自動使用
1. 用戶正常使用應用進行對話
2. 系統會在每晚10點自動分析當日對話
3. 生成的洞察會保存到數據庫
4. 用戶可在心情頁面查看歷史洞察

### 手動觸發
1. 在心情頁面點擊歷史按鈕（時鐘圖標）
2. 在歷史頁面點擊"生成今日總結"
3. 系統會立即分析並生成總結

### 查看洞察
1. 打開心情頁面
2. 點擊右上角的歷史按鈕
3. 瀏覽歷史總結列表
4. 點擊任意總結查看詳細內容

## 技術架構

```
用戶對話 → SummaryService → 百鍊AI分析 → Supabase存儲 → 前端展示
    ↓
SchedulerService (每晚10點自動執行)
    ↓
DailyInsightCard / SummaryHistoryView (UI展示)
```

## 數據流程

1. **數據收集**: 從 `chat_messages` 表獲取當日對話
2. **AI分析**: 使用百鍊API進行心理學分析
3. **結果存儲**: 保存到 `daily_summaries` 表
4. **前端展示**: 通過React Native組件展示
5. **用戶交互**: 支持查看、刷新、歷史瀏覽

## 配置要求

### 環境變量
```
EXPO_PUBLIC_BAILIAN_API_KEY=你的百鍊API密鑰
EXPO_PUBLIC_BAILIAN_ENDPOINT=https://dashscope.aliyuncs.com
```

### 數據庫權限
- 確保Supabase項目已啟用RLS
- `daily_summaries` 表的策略已正確配置

## 監控和維護

### 日誌記錄
系統會記錄以下信息：
- 調度任務執行狀態
- AI分析成功/失敗
- 數據庫操作結果
- 用戶交互事件

### 錯誤處理
- **AI分析失敗**: 提供基本總結作為備選
- **數據庫錯誤**: 顯示友好的錯誤信息
- **網絡問題**: 支持重試機制

## 未來擴展

### 可能的增強功能
1. **推送通知**: 總結完成後發送通知
2. **數據導出**: 支持導出心理健康報告
3. **趨勢分析**: 長期心理健康趨勢圖表
4. **專業報告**: 生成適合分享給心理師的報告
5. **個性化調度**: 允許用戶自定義總結時間

### 性能優化
1. **緩存機制**: 緩存常用的分析結果
2. **批量處理**: 支持批量生成多日總結
3. **增量分析**: 只分析新增的對話內容

## 故障排除

### 常見問題
1. **總結沒有自動生成**: 檢查調度服務是否正常運行
2. **AI分析失敗**: 檢查百鍊API配置和網絡連接
3. **數據無法保存**: 檢查Supabase連接和權限設置
4. **前端顯示異常**: 檢查組件狀態和數據格式

### 調試方法
1. 查看控制台日誌
2. 檢查AsyncStorage中的調度任務
3. 驗證數據庫中的記錄
4. 測試AI API連接

---

## 總結

這個每日心理總結功能為Soulmate應用提供了強大的心理健康分析能力，結合了AI技術和專業心理學知識，為用戶提供有價值的洞察和建議。系統設計考慮了自動化、隱私保護和用戶體驗，是一個完整且可靠的解決方案。
